# Simple Tuner - Техническое Задание (v2.1)

## 1. Обзор проекта

**Название**: Simple Tuner  
**Тип**: Веб-приложение для настройки гитары  
**Платформа**: Одностраничное веб-приложение (SPA)  
**Целевые устройства**: Десктоп (ноутбуки) и мобильные устройства (iPhone, Android)  
**Новые возможности v2.1**: Настраиваемый Concert A Reference, повышенная точность до ±0.5 цента  

## 2. Функциональные требования

### 2.1 Use Case 1: Воспроизведение эталонных частот

**Актор**: Пользователь  
**Предусловие**: Веб-страница загружена в браузере  
**Основной сценарий**:
1. Пользователь видит 6 кнопок, соответствующих струнам гитары (E4-B3-G3-D3-A2-E2)
2. Пользователь нажимает на кнопку нужной струны
3. Система автоматически переключается в режим "Эталон"
4. Система воспроизводит эталонную частоту выбранной струны с учетом настройки Concert A
5. Воспроизведение происходит согласно выбранному режиму (короткий/длинный сигнал)
6. Кнопка выбранной струны подсвечивается для ручной настройки

**Альтернативные сценарии**:
- Пользователь может остановить воспроизведение досрочно кнопкой "стоп"
- Пользователь может переключить режим воспроизведения (2 секунды / непрерывно)
- Пользователь может изменить Concert A Reference для всех струн одновременно

**Постусловие**: Звук воспроизведен с правильной эталонной частотой, активирован режим ручной настройки выбранной струны

### 2.2 Use Case 2: Автоматический анализ звука с микрофона

**Актор**: Пользователь  
**Предусловие**: Разрешен доступ к микрофону, режим "Тюнер" активен  
**Основной сценарий**:
1. Пользователь извлекает звук на гитаре
2. Система захватывает аудио через микрофон
3. Система анализирует частоту с точностью ±0.5 цента и определяет ближайшую струну автоматически
4. Система отображает (с учетом Concert A настройки):
   - Какая струна настраивается (подсветка соответствующей кнопки)
   - Отклонение в центах от эталонной частоты
   - Визуальную индикацию направления настройки (подтянуть/ослабить)

**Альтернативные сценарии**:
- Если частота вне диапазона ±100 центов от любой струны - показать "частота не распознана"
- Если сигнал слишком слабый - показать "Слишком тихо"
- Если сигнал перегружен - показать предупреждение "Слишком громко" но продолжать анализ

**Постусловие**: Пользователь видит точную информацию о настройке струны

### 2.3 Use Case 3: Ручная настройка выбранной струны

**Актор**: Пользователь  
**Предусловие**: Нажата кнопка конкретной струны  
**Основной сценарий**:
1. Пользователь нажимает кнопку струны для выбора
2. Кнопка подсвечивается, указывая на активный режим ручной настройки
3. Пользователь извлекает звук на выбранной струне
4. Система анализирует только отклонение от выбранной эталонной частоты (с учетом Concert A)
5. Отображается точное отклонение в центах без ограничений по диапазону
6. Показывается направление настройки с точностью ±0.5 цента (выше/ниже эталона)

**Альтернативные сценарии**:
- Пользователь может переключиться в автоматический режим через переключатель
- Пользователь может выбрать другую струну, нажав другую кнопку
- Пользователь может изменить Concert A Reference, что пересчитает эталонную частоту

**Постусловие**: Струна настроена с высокой точностью

### 2.4 Use Case 4: Настройка Concert A Reference

**Актор**: Пользователь  
**Предусловие**: Интерфейс загружен  
**Основной сценарий**:
1. Пользователь видит текущее значение Concert A Reference (по умолчанию 440.0Hz)
2. Пользователь может изменить значение в диапазоне 435.0-445.0Hz
3. Система пересчитывает все эталонные частоты струн в реальном времени
4. Если активен режим "Тюнер", показания обновляются немедленно
5. Новое значение сохраняется в локальном хранилище

**Альтернативные сценарии**:
- Пользователь может сбросить значение к стандартному (440.0Hz)
- При некорректном вводе система показывает предупреждение и возвращает предыдущее значение

**Постусловие**: Все эталонные частоты пересчитаны согласно новому Concert A

### 2.5 Use Case 5: Автоматическое переключение режимов (экспериментальный)

**Актор**: Система  
**Предусловие**: Активен экспериментальный режим автоопределения  
**Основной сценарий**:
1. Система находится в режиме "готов к воспроизведению"
2. Система мониторит уровень входного сигнала
3. При резком увеличении амплитуды сигнала (превышение порога)
4. Система ждет 500мс для стабилизации
5. Автоматически переключается в режим "Тюнер"
6. После 10 секунд тишины возвращается в режим "готов к воспроизведению"

**Постусловие**: Удобство использования без ручных переключений

### 2.6 Use Case 6: Управление режимами и настройками

**Актор**: Пользователь  
**Предусловие**: Интерфейс загружен  
**Основной сценарий**:
1. Пользователь видит переключатели режимов:
   - Длительность воспроизведения (короткий/длинный сигнал)
   - Режим работы (Эталон/Тюнер/Авто)
   - Concert A Reference (435.0-445.0Hz)
2. Пользователь переключает нужный режим
3. Система применяет настройки ко всем функциям
4. Визуальная обратная связь подтверждает изменения

**Постусловие**: Режимы настроены согласно предпочтениям пользователя

## 3. Технические требования

### 3.1 Архитектура
- **Тип**: Single Page Application (SPA)
- **Технологический стек**: HTML5, CSS3, JavaScript (ES6+), Web Audio API
- **Аудио**: Web Audio API для генерации тонов и анализа частот
- **Алгоритм анализа**: FFT (Fast Fourier Transform) для частотного анализа
- **Новые возможности**: Динамический Concert A Reference с переменными частотами

### 3.2 Эталонные частоты струн

#### 3.2.1 Базовые частоты при Concert A = 440.0Hz
```
1-я струна (E4): 329.628 Hz
2-я струна (B3): 246.942 Hz  
3-я струна (G3): 195.998 Hz
4-я струна (D3): 146.832 Hz
5-я струна (A2): 110.000 Hz
6-я струна (E2): 82.407 Hz
```

#### 3.2.2 Формула пересчета для Concert A
Для любого Concert A (CA):
```
Частота_струны = Базовая_частота × (CA / 440.0)
```

**Примеры**:
- При CA = 442.0Hz: E4 = 329.628 × (442/440) = 331.109 Hz
- При CA = 438.0Hz: E4 = 329.628 × (438/440) = 327.145 Hz

### 3.3 Параметры анализа звука

#### 3.3.1 FFT Конфигурация (улучшенная)
- **Sample Rate**: Используется текущий sample rate аудиокарты
- **FFT размер**: 8192 семплов для точности ±0.5 цента
- **Окно**: Hanning window для лучшей частотной точности
- **Частота обновления**: 15-25 раз в секунду
- **Сглаживание**: Скользящее среднее по 5 последовательным измерениям

#### 3.3.2 Алгоритм высокой точности
- **Интерполяция спектра**: Параболическая интерполяция для субточечной точности
- **Фильтрация гармоник**: Выделение основной частоты из гармонического ряда
- **Временная корреляция**: Анализ стабильности частоты во времени
- **Адаптивное сглаживание**: Больше усреднения для нестабильных сигналов

#### 3.3.3 Пороговые значения (обновленные)
- **Точность измерения**: ±0.5 цента
- **Минимальный уровень сигнала**: -40dB для начала анализа
- **Максимальный уровень перегрузки**: 0dB (предупреждение, но анализ продолжается)
- **Порог автоопределения струны**: ±100 центов от эталонной частоты
- **Стабильность частоты**: 5 последовательных измерений в пределах ±1 цента
- **Таймаут тишины**: 30 секунд для прекращения анализа
- **Автопереключение**: 500мс задержка после обнаружения сигнала
- **Возврат в режим ожидания**: 10 секунд тишины

#### 3.3.4 Алгоритм определения струны (расширенный)
1. **Анализ амплитуды**: Выбор самой громкой частотной составляющей
2. **Фильтрация диапазона**: Игнорирование частот вне 75-370Hz (для 435-445Hz Concert A)
3. **Пересчет эталонов**: Применение текущего Concert A к базовым частотам
4. **Сравнение с эталонами**: Вычисление отклонения в центах от всех 6 струн
5. **Выбор ближайшей**: Струна с минимальным отклонением
6. **Проверка порога**: 
   - Автоматический режим: отклонение ≤±100 центов
   - Ручной режим: без ограничений

### 3.4 Производительность (обновленные требования)
- **Отклик тюнера**: < 80мс
- **Время загрузки**: < 3 секунды
- **Размер файлов**: < 1.2MB общий размер
- **Обновление индикаторов**: 15-25 FPS

### 3.5 Совместимость
- **Браузеры**: Chrome 80+, Safari 13+, Firefox 75+, Edge 80+
- **Устройства**: Desktop, iPhone (iOS 13+), Android (Chrome 80+)
- **Ориентация**: Portrait и Landscape
- **Разрешения**: 320px - 1920px ширина

## 4. UI/UX требования

### 4.1 Дизайн-концепция
- **Стиль**: Современный минимализм с элементами скевоморфизма
- **Цветовая схема**: Светлые тона с акцентами
- **Вдохновение**: Музыкальные проигрыватели 90х в современной интерпретации
- **Принцип**: Интуитивно понятный интерфейс без инструкций

### 4.2 Компоненты интерфейса

#### 4.2.1 Кнопки струн
- **Количество**: 6 кнопок
- **Подписи**: E, B, G, D, A, E (с указанием октавы)
- **Размер**: Минимум 44px для мобильных устройств
- **Расположение**: Вертикально или горизонтально (адаптивно)
- **Состояния**: 
  - Обычное (неактивная струна)
  - Нажатое (момент нажатия)
  - Активное воспроизведение (эталон звучит)
  - Выбранная для ручной настройки (подсветка)
  - Автоопределенная струна (подсветка в режиме тюнера)

#### 4.2.2 Индикатор настройки (высокая точность)
- **Тип**: Аналоговая шкала + числовое значение в центах
- **Диапазон шкалы**: -50 до +50 центов
- **Точность отображения**: 0.5 цента
- **Визуальная индикация**:
  - Зеленая зона: ±2 цента (точная настройка)
  - Желтая зона: ±2-10 центов (близко)
  - Красная зона: >±10 центов (далеко)
- **Стрелка/указатель**: В стиле VU-метра с высокой точностью
- **Числовое значение**: Крупно, четко видимо, с точностью до 0.5 цента
- **Расширенный диапазон**: При ручном режиме может показывать >±50 центов

#### 4.2.3 Элементы управления

**Переключатель длительности воспроизведения**:
- **Иконки**: ♪ (короткий 2 сек) / ♫ (длинный непрерывно)
- **Тип**: Toggle переключатель
- **Применение**: Ко всем кнопкам струн

**Переключатель режимов работы**:
- **Режимы**: 
  - "Эталон" - только воспроизведение
  - "Тюнер" - только анализ микрофона
  - "Авто" - автоматическое переключение
- **Тип**: Радио-кнопки или сегментированный контрол
- **Индикация**: Четкое отображение активного режима

**Concert A Reference настройка**:
- **Диапазон**: 435.0-445.0Hz с шагом 0.1Hz
- **Элемент управления**: Slider + числовое поле ввода
- **Индикация**: Постоянное отображение текущего значения
- **Кнопка сброса**: Быстрый возврат к 440.0Hz
- **Применение**: Немедленное обновление всех эталонных частот

**Кнопка остановки звука**:
- **Иконка**: ⏹ или ✕
- **Функция**: Остановка всех воспроизводимых звуков
- **Доступность**: Видна только при активном воспроизведении

#### 4.2.4 Индикаторы состояния

**Уровень входного сигнала**:
- **Отображение**: Графический индикатор + числовое значение в dB
- **Цветовая кодировка**:
  - Красный: < -40dB ("Слишком тихо")
  - Зеленый: -40dB до -6dB ("Нормально") 
  - Желтый: -6dB до 0dB ("Громко")
  - Красный мигающий: ≥0dB ("Слишком громко")
- **Расположение**: Внизу интерфейса

**Индикатор точности**:
- **Отображение**: "Точность: ±0.5¢" в углу интерфейса
- **Функция**: Напоминание о высокой точности измерений

**Индикатор Concert A**:
- **Отображение**: "A = 440.0Hz" (обновляется при изменении)
- **Расположение**: Рядом с элементами управления
- **Функция**: Постоянное напоминание о текущей настройке

**Статус микрофона**:
- **Текст**: "Микрофон активен" / "Доступ к микрофону запрещен"
- **Индикация**: При отказе в доступе - просьба обновить страницу
- **Автозапрос**: При каждой загрузке страницы

**Индикатор текущего режима**:
- **Отображение**: Ясная визуальная индикация активного режима
- **Обратная связь**: Немедленное обновление при переключении

### 4.3 Адаптивность
- **Мобильные устройства**: Вертикальное расположение элементов
- **Десктоп**: Горизонтальное или смешанное расположение
- **Touch-friendly**: Все элементы удобны для касания пальцем

### 4.4 Состояния и переходы
- **Загрузка**: Индикатор загрузки с процентами
- **Переключение режимов**: Плавные анимации переходов
- **Изменение Concert A**: Плавное обновление всех частотных индикаторов
- **Обратная связь**: Визуальный отклик на все действия пользователя
- **Обработка ошибок**: Понятные сообщения об ошибках

## 5. Техническая реализация

### 5.1 Рекомендуемая архитектура файлов
```
simple_tuner/
├── index.html
├── css/
│   └── styles.css
├── js/
│   ├── app.js
│   ├── audio-engine.js
│   ├── tuner.js
│   ├── frequency-analyzer.js
│   ├── concert-a-manager.js
│   └── ui.js
├── assets/
│   └── icons/
└── manifest.json
```

### 5.2 Ключевые модули

**AudioEngine**:
- Web Audio API управление с переменным Concert A
- Генерация эталонных тонов с учетом текущего Concert A Reference
- Захват микрофона с улучшенными параметрами
- Обработка переключения режимов
- Синхронизация с ConcertAManager для обновления частот

**FrequencyAnalyzer (улучшенный)**:
- FFT анализ входящего сигнала с повышенной точностью (8192 семпла)
- Алгоритм определения основной частоты с параболической интерполяцией
- Фильтрация шума и адаптивное сглаживание (5 измерений)
- Вычисление отклонений в центах с точностью ±0.5
- Временная корреляция для стабильности показаний
- Выделение основной частоты из гармонического ряда

**ConcertAManager (новый модуль)**:
- Управление настройкой Concert A Reference в диапазоне 435.0-445.0Hz
- Пересчет всех эталонных частот струн в реальном времени
- Валидация входных данных и обработка ошибок
- Сохранение настроек в localStorage с резервным копированием
- Уведомление других модулей об изменениях через события
- API для получения текущих частот струн
- Функция сброса к стандартному значению 440.0Hz

**Tuner**:
- Логика определения ближайшей струны с учетом переменного Concert A
- Управление пороговыми значениями для повышенной точности
- Алгоритм стабилизации показаний (5 последовательных измерений)
- Автоматическое переключение режимов с улучшенной логикой
- Интеграция с ConcertAManager для динамического обновления эталонов
- Расширенная фильтрация диапазона частот (75-370Hz)

**UI**:
- Управление визуальными компонентами с поддержкой Concert A настроек
- Обновление индикаторов в реальном времени (15-25 FPS)
- Обработка пользовательских действий включая Concert A управление
- Адаптивный дизайн с новыми элементами управления
- Анимации при изменении Concert A Reference
- Валидация пользовательского ввода в реальном времени

**App**:
- Координация всех модулей включая новый ConcertAManager
- Управление состоянием приложения с поддержкой Concert A
- Обработка ошибок и восстановление после сбоев
- Инициализация системы с загрузкой сохраненных настроек
- Глобальная шина событий для межмодульного взаимодействия
- Мониторинг производительности и оптимизация

### 5.3 Оффлайн поддержка
- **Service Worker**: Кэширование для работы без интернета
- **Manifest**: Web App Manifest для установки как PWA
- **Локальное хранение**: Сохранение пользовательских настроек, включая Concert A Reference
- **Резервное копирование**: Автоматическое создание backup настроек
- **Восстановление**: Функция восстановления настроек по умолчанию

### 5.4 API модулей

#### 5.4.1 ConcertAManager API
```javascript
class ConcertAManager {
  // Основные методы
  setConcertA(frequency)     // Установка Concert A (435.0-445.0Hz)
  getConcertA()              // Получение текущего Concert A
  reset()                    // Сброс к 440.0Hz
  
  // Расчет частот
  getStringFrequency(stringIndex)  // Частота струны с учетом Concert A
  getAllStringFrequencies()        // Массив всех частот струн
  
  // События и сохранение
  addEventListener(event, callback) // Подписка на изменения
  saveSettings()                   // Сохранение в localStorage
  loadSettings()                   // Загрузка из localStorage
}
```

#### 5.4.2 FrequencyAnalyzer API (расширенный)
```javascript
class FrequencyAnalyzer {
  // Анализ с повышенной точностью
  analyzeFrequency(audioData)      // Возвращает частоту ±0.5¢
  getFrequencyStability()          // Стабильность измерений
  
  // Настройки точности
  setInterpolationMode(mode)       // Параболическая/линейная
  setHarmonicFiltering(enabled)    // Включение фильтрации гармоник
  setSmoothingFactor(factor)       // Коэффициент сглаживания (1-10)
}
```

#### 5.4.3 Tuner API (обновленный)
```javascript
class Tuner {
  // Основные функции с Concert A поддержкой
  detectString(frequency)          // Определение струны с учетом Concert A
  calculateCentOffset(frequency, stringIndex) // Отклонение в центах
  
  // Настройки точности
  setAccuracyMode(mode)           // ±0.5¢ или ±1¢ режим
  setStabilityThreshold(cents)    // Порог стабильности
  setConcertAManager(manager)     // Подключение Concert A Manager
}
```